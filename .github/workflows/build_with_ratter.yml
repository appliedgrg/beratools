name: Build with ratter-build

on:
  push:
    tags:
      - '*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Pixi
        run: |
          curl -fsSL https://pixi.sh/install.sh | bash
          echo "$HOME/.pixi/bin" >> $GITHUB_PATH

      - name: Install rattler-build with Pixi
        run: |
          pixi global install rattler-build

      - name: Set VERSION from tag
        run: |
          export GIT_TAG=${GITHUB_REF##*/}
          export VERSION=$(echo ${GITHUB_REF##*/} | sed 's/^main\/v//')
      - name: Build with rattler-build
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          cd packaging
          rattler-build build -c appliedgrg -c conda-forge --no-test --no-include-recipe --recipe recipe.yaml

      - name: Install anaconda-client with Pixi
        run: |
          pixi global install anaconda-client

      - name: Ensure Pixi bin in PATH
        run: |
          echo "$HOME/.pixi/bin" >> $GITHUB_PATH

      - name: Publish to Anaconda.org
        env:
          ANACONDA_API_TOKEN: ${{ secrets.ANACONDA_API_TOKEN }}
        run: |
          binstar upload packaging/output/*.conda --user appliedgrg --channel appliedgrg || binstar upload packaging/output/*.tar.bz2 --user appliedgrg --channel appliedgrg
